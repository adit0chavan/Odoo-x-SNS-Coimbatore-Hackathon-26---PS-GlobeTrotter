{% extends "base.html" %}

{% block title %}Admin Console - GlobeTrotter{% endblock %}

{% block content %}
<div class="admin-layout">
    <!-- Admin Sidebar -->
    <aside class="admin-sidebar">
        <div class="sidebar-header">
            <span class="badge badge-primary mb-2">Admin Console</span>
            <h5 class="mb-0">Control Center</h5>
        </div>

        <nav class="sidebar-nav">
            <a href="#overview" class="sidebar-link active" onclick="setActive(this)">
                <span class="icon icon-sm">dashboard</span> Overview
            </a>
            <a href="#users" class="sidebar-link" onclick="setActive(this)">
                <span class="icon icon-sm">group</span> Users
            </a>
            <a href="#trips" class="sidebar-link" onclick="setActive(this)">
                <span class="icon icon-sm">flight_takeoff</span> Trips
            </a>
            <a href="#settings" class="sidebar-link" onclick="setActive(this)">
                <span class="icon icon-sm">settings</span> Settings
            </a>
        </nav>

        <div class="sidebar-profile mt-auto">
            <div class="d-flex align-center gap-3">
                <div class="avatar-sm">
                    {{ current_user.username[0]|upper }}
                </div>
                <div>
                    <p class="text-sm fw-bold mb-0">{{ current_user.username }}</p>
                    <p class="text-xs text-muted mb-0">System Admin</p>
                </div>
            </div>
        </div>
    </aside>

    <!-- Admin Content -->
    <main class="admin-content">
        <!-- Dashboard Header -->
        <div class="d-flex justify-between align-center mb-6" id="overview">
            <div>
                <h1 class="h3 mb-1">Platform Overview</h1>
                <p class="text-gray">Real-time system metrics and management</p>
            </div>
            <div class="d-flex gap-2">
                <button onclick="window.location.reload()" class="btn btn-outline btn-sm">
                    <span class="icon icon-sm">refresh</span> Refresh
                </button>
            </div>
        </div>

        <!-- Metrics Grid -->
        <div class="grid grid-cols-3 gap-4 mb-8">
            <div class="card stat-card p-6">
                <div class="d-flex justify-between align-start mb-4">
                    <div class="stat-icon primary">
                        <span class="icon">group</span>
                    </div>
                    <span class="badge badge-success">+12%</span>
                </div>
                <h3 class="h2 mb-0">{{ total_users }}</h3>
                <p class="text-gray text-sm">Total Register Users</p>
            </div>

            <div class="card stat-card p-6">
                <div class="d-flex justify-between align-start mb-4">
                    <div class="stat-icon secondary">
                        <span class="icon">flight</span>
                    </div>
                    <span class="badge badge-secondary">Active</span>
                </div>
                <h3 class="h2 mb-0">{{ total_trips }}</h3>
                <p class="text-gray text-sm">Trips Created</p>
            </div>

            <div class="card stat-card p-6">
                <div class="d-flex justify-between align-start mb-4">
                    <div class="stat-icon accent">
                        <span class="icon">map</span>
                    </div>
                    <span class="badge badge-warning">Growth</span>
                </div>
                <h3 class="h2 mb-0">{{ total_stops }}</h3>
                <p class="text-gray text-sm">Total Destinations</p>
            </div>

            <div class="card stat-card p-6">
                <div class="d-flex justify-between align-start mb-4">
                    <div class="stat-icon primary">
                        <span class="icon">account_balance</span>
                    </div>
                    <span class="badge badge-primary">Financials</span>
                </div>
                <h3 class="h2 mb-0">${{ "%.2f"|format(total_estimated_budget) }}</h3>
                <p class="text-gray text-sm">Total Planned Budget</p>
            </div>

            <div class="card stat-card p-6">
                <div class="d-flex justify-between align-start mb-4">
                    <div class="stat-icon secondary">
                        <span class="icon">payments</span>
                    </div>
                    <span class="badge badge-success">Actual</span>
                </div>
                <h3 class="h2 mb-0">${{ "%.2f"|format(total_actual_spend) }}</h3>
                <p class="text-gray text-sm">Total Platform Spend</p>
            </div>
        </div>

        <!-- Users Section -->
        <div class="card mb-8" id="users">
            <div class="card-header d-flex justify-between align-center">
                <h2 class="h5 mb-0">User Management</h2>
                <div class="d-flex gap-2">
                    <div class="search-mini">
                        <span class="icon icon-sm text-gray">search</span>
                        <input type="text" placeholder="Search users...">
                    </div>
                </div>
            </div>
            <div class="card-body p-0 overflow-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Email</th>
                            <th>Role</th>
                            <th>Joined</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in all_users %}
                        <tr>
                            <td>
                                <div class="d-flex align-center gap-2">
                                    <div class="avatar-xs bg-gray-100">{{ user.username[0]|upper }}</div>
                                    <span class="fw-medium">{{ user.username }}</span>
                                </div>
                            </td>
                            <td class="text-gray">{{ user.email }}</td>
                            <td>
                                {% if user.is_admin %}
                                <span class="badge badge-primary">Admin</span>
                                {% else %}
                                <span class="badge badge-secondary">User</span>
                                {% endif %}
                            </td>
                            <td class="text-gray text-sm">{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                            <td class="text-right">
                                <div class="d-flex justify-end gap-2">

                                    <form action="{{ url_for('admin.delete_user', user_id=user.id) }}" method="POST"
                                        class="d-inline"
                                        onsubmit="return confirm('Are you sure you want to delete this user? This cannot be undone.')">
                                        <button type="submit" class="btn btn-ghost btn-sm text-danger"
                                            title="Delete User" {% if user.id==current_user.id %}disabled{% endif %}>
                                            <span class="icon icon-sm">delete</span>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Trips Section -->
        <div class="card" id="trips">
            <div class="card-header d-flex justify-between align-center">
                <h2 class="h5 mb-0">Trip Management</h2>
                <span class="text-sm text-gray">{{ total_trips }} total trips</span>
            </div>
            <div class="card-body p-0 overflow-auto">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Trip Name</th>
                            <th>Created By</th>
                            <th>Status</th>
                            <th>Date</th>
                            <th class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trip in all_trips %}
                        <tr>
                            <td>
                                <a href="{{ url_for('trips.view_trip', trip_id=trip.id) }}" class="fw-medium text-dark"
                                    style="text-decoration: none;">
                                    {{ trip.name }}
                                </a>
                            </td>
                            <td>
                                <div class="d-flex align-center gap-2">
                                    <span class="text-sm text-gray">{{ trip.user.username }}</span>
                                </div>
                            </td>
                            <td>
                                {% if trip.is_public %}
                                <span class="badge badge-success">Public</span>
                                {% else %}
                                <span class="badge badge-secondary">Private</span>
                                {% endif %}
                            </td>
                            <td class="text-gray text-sm">{{ trip.created_at.strftime('%Y-%m-%d') }}</td>
                            <td class="text-right">
                                <form action="{{ url_for('admin.delete_trip', trip_id=trip.id) }}" method="POST"
                                    class="d-inline"
                                    onsubmit="return confirm('Delete this trip? This cannot be undone.')">
                                    <button type="submit" class="btn btn-ghost btn-sm text-danger" title="Delete Trip">
                                        <span class="icon icon-sm">delete</span>
                                    </button>
                                </form>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </main>
</div>

<style>
    /* Layout */
    .admin-layout {
        display: grid;
        grid-template-columns: 280px 1fr;
        min-height: calc(100vh - 80px);
        margin-top: -1px;
        /* Align with navbar border */
    }

    /* Sidebar */
    .admin-sidebar {
        background: var(--white);
        border-right: 1px solid var(--gray-200);
        padding: 1.5rem;
        display: flex;
        flex-direction: column;
        position: sticky;
        top: 80px;
        height: calc(100vh - 80px);
    }

    .sidebar-header {
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid var(--gray-100);
    }

    .sidebar-nav {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .sidebar-link {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem 1rem;
        color: var(--text-gray);
        text-decoration: none;
        border-radius: var(--radius-md);
        transition: var(--transition);
        font-weight: 500;
    }

    .sidebar-link:hover {
        background: var(--gray-50);
        color: var(--primary);
    }

    .sidebar-link.active {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary);
    }

    /* Main Content */
    .admin-content {
        background: var(--gray-50);
        padding: 2rem;
    }

    /* Avatars */
    .avatar-sm {
        width: 40px;
        height: 40px;
        background: var(--primary);
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
    }

    .avatar-xs {
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--text-gray);
    }

    /* Tables */
    .table {
        width: 100%;
        border-collapse: collapse;
    }

    .table th {
        text-align: left;
        padding: 1rem 1.5rem;
        font-weight: 600;
        color: var(--text-gray);
        font-size: 0.875rem;
        border-bottom: 1px solid var(--gray-200);
        background: var(--gray-50);
    }

    .table td {
        padding: 1rem 1.5rem;
        border-bottom: 1px solid var(--gray-100);
        vertical-align: middle;
    }

    .table tr:last-child td {
        border-bottom: none;
    }

    .table tr:hover {
        background: var(--gray-50);
    }

    /* Search */
    .search-mini {
        position: relative;
        display: flex;
        align-items: center;
    }

    .search-mini input {
        padding: 0.5rem 0.75rem 0.5rem 2rem;
        border: 1px solid var(--gray-200);
        border-radius: var(--radius-md);
        font-size: 0.875rem;
        width: 200px;
        outline: none;
        transition: var(--transition);
    }

    .search-mini input:focus {
        border-color: var(--primary);
        width: 240px;
    }

    .search-mini .icon {
        position: absolute;
        left: 0.5rem;
        pointer-events: none;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .admin-layout {
            grid-template-columns: 80px 1fr;
        }

        .sidebar-link span:not(.icon),
        .sidebar-header,
        .sidebar-profile p {
            display: none;
        }

        .admin-sidebar {
            padding: 1rem 0.5rem;
            align-items: center;
        }

        .sidebar-link {
            justify-content: center;
            padding: 0.75rem;
        }
    }

    @media (max-width: 768px) {
        .admin-layout {
            display: block;
        }

        .admin-sidebar {
            display: none;
            /* Can add mobile toggle later */
        }

        .admin-content {
            padding: 1rem;
        }

        .grid-cols-3 {
            grid-template-columns: 1fr;
        }
    }
</style>

<script>
    function setActive(element) {
        document.querySelectorAll('.sidebar-link').forEach(link => {
            link.classList.remove('active');
        });
        element.classList.add('active');
    }
</script>
{% endblock %}